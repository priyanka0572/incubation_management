name: CI/CD Pipeline for EKS Servicesname: CI/CD Pipeline for EKS Servicesname: CI/CD Pipeline for EKS Services



on:

  push:

    branches:on:on:

      - main   # Trigger workflow on push to main branch

  push:  push:

jobs:

  build-deploy:    branches:    branches:

    runs-on: ubuntu-latest

      - main   # Trigger workflow on push to main branch      - main   # Trigger workflow on push to main branch

    steps:

    - name: Checkout repository

      uses: actions/checkout@v4

jobs:jobs:

    # üîë Docker Hub login

    - name: Log in to Docker Hub  build-deploy:  build-deploy:

      uses: docker/login-action@v3

      with:    runs-on: ubuntu-latest    runs-on: ubuntu-latest

        username: ${{ secrets.DOCKER_USERNAME }}

        password: ${{ secrets.DOCKER_PASSWORD }}



    # üîç Debug: List repository structure    steps:    steps:

    - name: List repository structure

      run: |    - name: Checkout repository    - name: Checkout repository

        echo "Repository root contents:"

        ls -la      uses: actions/checkout@v4      uses: actions/checkout@v4

        echo "COE_Api contents:"

        ls -la COE_Api/ || echo "COE_Api directory not found"

        echo "Incubation_Backend contents:"

        ls -la Incubation_Backend/ || echo "Incubation_Backend directory not found"    # üîë Docker Hub login    # ÔøΩ Docker Hub login



    # üê≥ Build & push COE API image    - name: Log in to Docker Hub    - name: Log in to Docker Hub

    - name: Build and push COE API

      run: |      uses: docker/login-action@v3      uses: docker/login-action@v3

        if [ ! -f ./COE_Api/Dockerfile ]; then

          echo "Dockerfile not found in COE_Api directory"      with:      with:

          exit 1

        fi        username: ${{ secrets.DOCKER_USERNAME }}        username: ${{ secrets.DOCKER_USERNAME }}

        docker build -t ${{ secrets.DOCKER_USERNAME }}/coe_api:latest ./COE_Api

        docker push ${{ secrets.DOCKER_USERNAME }}/coe_api:latest        password: ${{ secrets.DOCKER_PASSWORD }}        password: ${{ secrets.DOCKER_PASSWORD }}



    # üê≥ Build & push Incubation Backend image

    - name: Build and push Incubation Backend

      run: |    # üîç Debug: List repository structure    # üîç Debug: List repository structure

        docker build -t ${{ secrets.DOCKER_USERNAME }}/coe_incubation_api:latest ./Incubation_Backend

        docker push ${{ secrets.DOCKER_USERNAME }}/coe_incubation_api:latest    - name: List repository structure    - name: List repository structure



    # üê≥ Build & push Project Management Service      run: |      run: |

    - name: Build and push Project Management Service

      run: |        echo "Repository root contents:"        echo "Repository root contents:"

        docker build -t ${{ secrets.DOCKER_USERNAME }}/project_api:latest ./Project-Management-ims

        docker push ${{ secrets.DOCKER_USERNAME }}/project_api:latest        ls -la        ls -la



    # üê≥ Build & push Student Service        echo "COE_Api contents:"        echo "COE_Api contents:"

    - name: Build and push Student Service

      run: |        ls -la COE_Api/ || echo "COE_Api directory not found"        ls -la COE_Api/ || echo "COE_Api directory not found"

        docker build -t ${{ secrets.DOCKER_USERNAME }}/student_api:latest ./student_management/backend

        docker push ${{ secrets.DOCKER_USERNAME }}/student_api:latest        echo "Incubation_Backend contents:"        echo "Incubation_Backend contents:"



    # ‚òÅÔ∏è AWS credentials        ls -la Incubation_Backend/ || echo "Incubation_Backend directory not found"        ls -la Incubation_Backend/ || echo "Incubation_Backend directory not found"

    - name: Configure AWS credentials

      uses: aws-actions/configure-aws-credentials@v4

      with:

        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}    # üê≥ Build & push COE API image    # ÔøΩüê≥ Build & push COE API image

        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

        aws-region: ${{ secrets.AWS_REGION }}    - name: Build and push COE API    - name: Build and push COE API



    # üîó Update kubeconfig for EKS      run: |      run: |

    - name: Update kubeconfig

      run: aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }}        if [ ! -f ./COE_Api/Dockerfile ]; then        if [ ! -f ./COE_Api/Dockerfile ]; then



    # üöÄ Deploy services to Kubernetes          echo "Dockerfile not found in COE_Api directory"          echo "Dockerfile not found in COE_Api directory"

    - name: Deploy COE Service (API + Backend)

      run: kubectl apply -f kubernetes/coe.yaml          exit 1          exit 1



    - name: Deploy Project Service        fi        fi

      run: kubectl apply -f kubernetes/project.yaml

        docker build -t ${{ secrets.DOCKER_USERNAME }}/coe_api:latest ./COE_Api        docker build -t ${{ secrets.DOCKER_USERNAME }}/coe_api:latest ./COE_Api

    - name: Deploy Student Service

      run: kubectl apply -f kubernetes/student.yaml        docker push ${{ secrets.DOCKER_USERNAME }}/coe_api:latest        docker push ${{ secrets.DOCKER_USERNAME }}/coe_api:latest



    # ‚úÖ Verify deployments      uses: actions/checkout@v4

    - name: Wait for deployments to be ready

      run: |    # üê≥ Build & push Incubation Backend image

        kubectl rollout status deployment/coe-api-deployment --timeout=300s

        kubectl rollout status deployment/project-api-deployment --timeout=300s    - name: Build and push Incubation Backend    # üîë Docker Hub login

        kubectl rollout status deployment/student-api-deployment --timeout=300s

      run: |    - name: Log in to Docker Hub

    - name: Get deployment status

      run: |        docker build -t ${{ secrets.DOCKER_USERNAME }}/coe_incubation_api:latest ./Incubation_Backend      uses: docker/login-action@v3

        kubectl get pods

        kubectl get services        docker push ${{ secrets.DOCKER_USERNAME }}/coe_incubation_api:latest      with:

        username: ${{ secrets.DOCKER_USERNAME }}

    # üê≥ Build & push Project Management Service        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Project Management Service

      run: |    # ÔøΩ Debug: List repository structure

        docker build -t ${{ secrets.DOCKER_USERNAME }}/project_api:latest ./Project-Management-ims    - name: List repository structure

        docker push ${{ secrets.DOCKER_USERNAME }}/project_api:latest      run: |

        echo "Repository root contents:"

    # üê≥ Build & push Student Service        ls -la

    - name: Build and push Student Service        echo "COE_Api contents:"

      run: |        ls -la COE_Api/ || echo "COE_Api directory not found"

        docker build -t ${{ secrets.DOCKER_USERNAME }}/student_api:latest ./student_management/backend        echo "Incubation_Backend contents:"

        docker push ${{ secrets.DOCKER_USERNAME }}/student_api:latest        ls -la Incubation_Backend/ || echo "Incubation_Backend directory not found"



    # ‚òÅÔ∏è AWS credentials    # ÔøΩüê≥ Build & push COE API image

    - name: Configure AWS credentials    - name: Build and push COE API

      uses: aws-actions/configure-aws-credentials@v4      run: |

      with:        docker build -t ${{ secrets.DOCKER_USERNAME }}/coe_api:latest ./COE_Api

        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}        docker push ${{ secrets.DOCKER_USERNAME }}/coe_api:latest

        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

        aws-region: ${{ secrets.AWS_REGION }}    # üê≥ Build & push Incubation Backend image

    - name: Build and push Incubation Backend

    # üîó Update kubeconfig for EKS      run: |

    - name: Update kubeconfig        docker build -t ${{ secrets.DOCKER_USERNAME }}/coe_incubation_api:latest ./Incubation_Backend

      run: aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }}        docker push ${{ secrets.DOCKER_USERNAME }}/coe_incubation_api:latest



    # üöÄ Deploy services to Kubernetes    # üê≥ Build & push Project Management Service

    - name: Deploy COE Service (API + Backend)    - name: Build and push Project Management Service

      run: kubectl apply -f kubernetes/coe.yaml      run: |

        docker build -t ${{ secrets.DOCKER_USERNAME }}/project_api:latest ./Project-Management-ims

    - name: Deploy Project Service        docker push ${{ secrets.DOCKER_USERNAME }}/project_api:latest

      run: kubectl apply -f kubernetes/project.yaml

    # üê≥ Build & push Student Service

    - name: Deploy Student Service    - name: Build and push Student Service

      run: kubectl apply -f kubernetes/student.yaml      run: |

        docker build -t ${{ secrets.DOCKER_USERNAME }}/student_api:latest ./student_management/backend

    # ‚úÖ Verify deployments        docker push ${{ secrets.DOCKER_USERNAME }}/student_api:latest

    - name: Wait for deployments to be ready

      run: |    # ‚òÅÔ∏è AWS credentials

        kubectl rollout status deployment/coe-api-deployment --timeout=300s    - name: Configure AWS credentials

        kubectl rollout status deployment/project-api-deployment --timeout=300s      uses: aws-actions/configure-aws-credentials@v4

        kubectl rollout status deployment/student-api-deployment --timeout=300s      with:

        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}

    - name: Get deployment status        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      run: |        aws-region: ${{ secrets.AWS_REGION }}

        kubectl get pods

        kubectl get services    # üîó Update kubeconfig for EKS
    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }}

    # üöÄ Deploy services to Kubernetes
    - name: Deploy COE Service (API + Backend)
      run: kubectl apply -f kubernetes/coe.yaml

    - name: Deploy Project Service
      run: kubectl apply -f kubernetes/project.yaml

    - name: Deploy Student Service
      run: kubectl apply -f kubernetes/student.yaml

    # ‚úÖ Verify deployments
    - name: Wait for deployments to be ready
      run: |
        kubectl rollout status deployment/coe-api-deployment --timeout=300s
        kubectl rollout status deployment/project-api-deployment --timeout=300s
        kubectl rollout status deployment/student-api-deployment --timeout=300s

    - name: Get deployment status
      run: |
        kubectl get pods
        kubectl get services
